메세지 큐를 도입할 이유가 있어서, RABBITMQ 를 통해서 AMQP 를 이해하고 있다.

도입 이유는 특정 관리 툴에서 이벤트를 발생시키면, 이 이벤트에 관심있는 벡엔드 서비스 풀의 서버(3대 정도)들이 모드 이벤트에 반응해야하는 미션이다. 캐시 갱신 관련된 내용으로 개발이 필요해졌다.

AMQP의 구성요소

- Exchange 

교환소 또는 중개소로 이해하면 쉽다. 메세지 생성자 (producer) 로 부터 메세지를 전달받으면, 메세지를 큐에 발송(실제로는 레퍼런스 연결이다)시켜준다.

- Queue

큐는 메세지 소비자 (consumer) 를 위한 메세지 저장 공간이다. 말 그대로 자료구조의 큐이다. 들어간 순서대로 소비자에 의해서 소비 된다.

참고로 아래에서 설명하겠지만, 큐에는 여러명의 소비자가 연결될수 있다. 기본적으로 큐는 소비자가 메세지를 읽어가면 메세지를 삭제한다. 이렇게 되면 N명의 소비자가 1개의 큐에 붙어있다고

N명이 모두 브로드캐스팅 되는 구조는 절대 불가능하다. 기본적으로 라운드로빈과 같은 알고리즘으로 큐에 붙은 소비자에게 병행 처리를 위한 개념으로 만들어진 것이 큐이다.

- Binding

Exchange 와 Queue 의 관계에 해당한다. Exchange는 여러개의 Queue와 묶일 수 있다. 여기서 묶일 수 있다에 해당하는 처리를 이 Binding 이 한다.

Exchange의 패턴(타입 이라고도 한다)

Exchange는 여러개의 Queue와 연결될 수 있다고 했다. Exchange 1-1 Queue 일수도 있고, Exchange 1-N Queue 일수도 있다는 말이다.

여기 패턴은 Exhcnage가 어떠한 Queue에 메세지를 전달해야할 지에 대한 패턴을 의미한다. 하나의 큐에 전송, 그룹에 전송, 그냥 모두다 전송 이런 느낌이다.

- Direct Exchange (특정 큐를 지정해서 발송)

내가 방송회사 다닐 때 나오던 용어가 나온다, Unicast 즉 특정 타겟을 지정해서 발송한다는 것이다.

어디 누구에게 보내줘라는 개념으로, Route Key 라는 놈이 나온다. 즉 Queue 의 주소를 Route Key라고 이해하면 쉽다.

- Fanout Exchange

Broadcast 말그대로 Exchange에 연결된 모든 Queue 아몰랑 하고 다 쏴버리는 거다.

- Topic Exchange

Multicast 이다. Route Key 에 해당하는 모든 Queue 에 전달한다. 사실 Direct와 Topic 의 차이점에 대해서 개념적으로는 비슷해보이지만, Direct는 N개의 Key가 매칭되도 하나만 보내는 거고, Topic 은 매칭 되는 N개 모두 발송해주는 패턴이다.

- Headers Exchange

좀 더 복잡한 Topic Exchange 라 보면 좋다. Route Key를 통해 발송해야할 Queue를 식별하는 개념이었다면, 이 Headers 의 경우 좀 더 추가적인 발송 이유에 해당하는 Queue에만 발송한다.

인증이라던지, 특정 그룹에 보낸다던지 여러개의 custom 한 Queue 발송 규칙으로 쏴라고 해놓은 것이다.



