---
layout: post
title:  "ReadOnly트러블슈팅"
author: "glqdlt"
---

# 개요

점심을 먹은 이후였던가, 갑자기 직장 동료가 도움을 요청했다. 이유는 엑셀 파일을 통해서 어떠한 칼럼의 데이터들을 추출해서 데이터베이스에 insert 하는 간단한 로직에서 에러가 발생한다는 내용이었다. 단순히 보면 도움을 요청할 만한 문제도 아니며 직접 에러를 트레이스 하면서 추적할 수 있겠지만 (더군다나 동료가 실력이 없어서 요청한 것은 아니다), 내가 챙피할 얘기는 아니지만 입사해서 파악했을 때 사내의 대부분 소스들이 히스토리 파악도 안 되어 있었으며 예외처리도 제대로 되어있지 않은 지저분한 코드들이 태반이었다. 거기다가 엎친데 덮친 겪으로 presetense layer 의 대부분이 당시 나를 포함한 신규 입사한 동기들이 익숙치 않은 xml mapper 기반의 데이터베이스에 종속 된 '프로시저' 로 되어있었기 때문에 더더욱 디버깅 하는 데 애를 먹는 상황이었다. 얘기가 조금 섔지만 나는 이 동료 보다는 몇 주 더 빨리 회사에 정착했고, 경력이 1년 더 앞섰던 사람으로, 이른바 믿음직스러운 동료이자 사수 같은 느낌의 위치에 있는 동료였던 셈이다.
도움에 응해서 동료의 자리로 가보았다. 이리저리 코드를 따라가 보니 역시 예상했던 데로 예외처리가 제대로 되어 있지 않았으며, 비지니스 로직은 '프로시저' 에 다 맡기고 있었으며 프로시저는 단순히 자기 로직을 끝내고 에러 메시지나 성공 메시지만 return 해줄 뿐이었다. 더 문제는 이 return 되는 메세지 조차 어플리케이션에서 로그를 남기지 않고 return 되는 메세지를 무시하고 하드코딩 되어서 에러가 발생할 경우 '에러가 발생했음' 정도로만 찍고 있었다.
일단 장애의 상황은 REAL 이라 불리우는 프로덕션 서버에서 일어나고 있었기 때문에, Local 에서 프로덕션 서버에 접근을 하더라도 OS 환경 자체가 다름으로 직접 에러에 대한 추적을 해볼 수 밖에 없었다. 여기서 내가 기대 했던 것은 자바 프로세스가 이슈 발생시에 자동으로 덤프를 남기게 해놓았다던가 WAS 에 에러 로그를 보는 방법을 생각하고 REAL 서버의 쉘에 접속해보았다. 역시 큰 기대 없었던 전자의 스레드 덤프와 같은 것은 되어 있지도 않았으며 (심지어 서비스가 수작업으로 start,shutdown 하게끔 되어있었다.) 다행히 후자인 로그를 남기는 것은 제대로 rolling append 되어 file 에 save 하고 있었다.
그런데 이상한 점이 장애 발생 시각과 달리 log 가 어제 저녁이후로 제대로 기록되어 있지 않은 게 아닌가? 심지어 기본적으로 쌓는 로그 파일이나 시스템 파일들 조차 모든 최종 기록이 전날 오후를 기점으로 되어있었다. 뭔가 이상해서 로깅을 하는 properties 파일을 뒤져보았지만, 이상한 점은 보이지 않았다. ps -ef 를 통해 java process가 정상적으로 실행되고 있는 것도 보았다. 순간 난 내눈을 의심하고 우리가 오픈 되어있는 프로덕션 웹 서비스를 내가 잘못 착각하고 있는 게 아닌가? 하는 생각도 했다. 이런저런 실험을 해보니 웹 서비스는 정상 동작중이었다. 문제의 실마리를 찾았던 것은 어플리케이션 root 로그 파일에 tail-f 걸어놓고 웹 서비스에 이것저것 인터렉션을 했는 데 당연히 출력되어야 할 info 로그 조차 출력되지 않는 것을 확인했다. 뭔가 이상한 느낌이 들어서 임의의 로그 파일을 만들거나 로그 파일을 삭제하려고 했더니 정상적으로 디스크 IO가 되지 않고, 'read only file system' 이란 OS 에러 로그가 출력되었다. 