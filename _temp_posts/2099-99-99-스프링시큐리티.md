---
layout: post
title:  "스프링 시큐리티"
author: "glqdlt"
---

기존 회사 소스 중에 스프링 시큐리티의 hasRole 에 값이 없는 걸 확인했다.


문제는 일반적으로 (개인적 경험으로) 접근 권한에 대해서 hasRole()로 'ROLE_USER,ROLE_ADMIN' 과 같은 정책을 많이 썼었다.


아래 코드에서 DB에 있는 권한을 메모리에 올리는 과정이 있다.


```java
    @Override
    public List<GrantedAuthority> extractAuthorities(Map<String, Object> map) {
        String authorities = "ROLE_USER";
        if (map.containsKey(AUTHORITIES)) {
            authorities = asAuthorities(map.get(AUTHORITIES));
        }
        return AuthorityUtils.commaSeparatedStringToAuthorityList(authorities);
    }

    private String asAuthorities(Object object) {
        List<Object> authorities = new ArrayList<Object>();
        if (object instanceof Collection) {
            Collection<?> collection = (Collection<?>) object;
            object = collection.toArray(new Object[0]);
        }
        if (ObjectUtils.isArray(object)) {
            Object[] array = (Object[]) object;
            for (Object value : array) {
                if (value instanceof String) {
                    authorities.add(value);
                }
                else if (value instanceof Map) {
                    authorities.add(asAuthority((Map<?, ?>) value));
                }
                else {
                    authorities.add(value);
                }
            }
            return StringUtils.collectionToCommaDelimitedString(authorities);
        }
        return object.toString();
    }

    private Object asAuthority(Map<?, ?> map) {
        if (map.size() == 1) {
            return map.values().iterator().next();
        }
        for (String key : AUTHORITY_KEYS) {
            if (map.containsKey(key)) {
                return map.get(key);
            }
        }
        return map;
    }


```

hasRole()을 때려도 데이터를 못가져오길래, 한번 뒤져봤다.

```java

ExpressionUrlAuthorizationConfigurer.class

...

  private static String hasAnyAuthority(String... authorities) {
        String anyAuthorities = StringUtils.arrayToDelimitedString(authorities, "','");
        return "hasAnyAuthority('" + anyAuthorities + "')";
    }

...

 private static String hasRole(String role) {
        Assert.notNull(role, "role cannot be null");
        if (role.startsWith("ROLE_")) {
            throw new IllegalArgumentException("role should not start with 'ROLE_' since it is automatically inserted. Got '" + role + "'");
        } else {
            return "hasRole('ROLE_" + role + "')";
        }
    }

```

보면 2개가 다르게 동작하고 있고, 보관하는 주소(key)도 다른 것을 알았다.

<!-- FIXME -->

나중에 시간이 되면 공식 문서를 더 봐야겠다.


조금 더 관찰력이 좋았다면, Authority 에 값을 넣는 걸 파악할 수 있었을 텐데 기초가 부족해서 놓치고 말았다.





프리마커 템플릿에서도 ```<@security.authorize access=hasRole(...)``` 이나 ```<@security.authorize access=hasAuthority(...)```와 같이 구문을 선언해서 사용할 수 있다.


