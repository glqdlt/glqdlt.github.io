---
layout: post
title:  "서브쿼리와 IN"
author: "glqdlt"
---

```sql
explain select  p.Seq as logSeq, 
                p.rid as roomId, 
                p.RoundLogSeq as roundLogSeq, 
                p.PlayerId as playerId, 
                p.DeviceKey as deviceKey, 
                p.IpAddress as ipAddress, 
                p.RegDate as regDate, 
                p.seatNum, 
                p.bcardSuffle, 
                p.mainBetChip, 
                p.dealerCard, 
                p.userCard, 
                m.StartChip as startChip, 
                m.BettingChip as bettingChip, 
                m.ChangeChip as changeChip, 
                m.EndChip as endChip, 
                r.RoundNo as roundNo, 
                p.userHandCard, 
                p.splitCount, 
                p.mainBetResultChip, 
                p.dealerCardJokbo, 
                p.userCardResultReason, 
                p.userCardJokbo, 
                p.bAllin, 
                p.playerCount, 
                p.vecUserActionLog, 
                r.ShuffleNo as shuffleNo, 
                r.StartDate as roundStartDate, 
                r.EndDate as roundEndDate, 
                ch.ChannelName as channelCode, 
                r2.RoomNo as roomNo,  
                p.sideBetChip as sideBettingChip,  
                p.side21Plus3BetChip as sideBettingTpChip  
                from mpoker_datadb.TB_BlackJackPlayerLog as p  
                join mpoker_datadb.TB_BlackJackRoundLog as r on r.Seq = p.RoundLogSeq  
                join mpoker_datadb.TB_BlackJackPlayerMoneyLog as m on m.RoundLogSeq = p.RoundLogSeq and m.PlayerId = p.PlayerId and m.rid = p.rid   
                join mpoker_datadb.TB_BlackJackRoomLog as r2 on r2.Rid = p.rid  
                join mpoker_configdb.TB_ChannelConfig_Baccarat as ch on ch.ChannelCode = r2.ChannelCode and ch.gameCode = 2002  
                where p.RoundLogSeq in  (select p2.RoundLogSeq from mpoker_datadb.TB_BlackJackPlayerLog as p2 
					 where p2.RegDate >= '2019-11-01' and p2.RegDate <= '2019-11-02' and p2.PlayerId = 'B36DEBE63689485E9AAC08A4983FD9DA')
```

문제의 쿼리 서브 쿼리에서 all 탐

```
{
	"table": "알 수 없는 테이블",
	"rows":
	[
		{
			"id": 1,
			"select_type": "SIMPLE",
			"table": "<subquery2>",
			"type": "ALL",
			"possible_keys": null,
			"key": null,
			"key_len": null,
			"ref": null,
			"rows": null,
			"Extra": null
		},
		{
			"id": 1,
			"select_type": "SIMPLE",
			"table": "r",
			"type": "eq_ref",
			"possible_keys": "PRIMARY",
			"key": "PRIMARY",
			"key_len": "8",
			"ref": "<subquery2>.RoundLogSeq",
			"rows": 1,
			"Extra": null
		},
		{
			"id": 1,
			"select_type": "SIMPLE",
			"table": "p",
			"type": "ref",
			"possible_keys": "fk_roundlogseq,idx_playerid,idx_rid",
			"key": "fk_roundlogseq",
			"key_len": "8",
			"ref": "<subquery2>.RoundLogSeq",
			"rows": 1,
			"Extra": "Using where"
		},
		{
			"id": 1,
			"select_type": "SIMPLE",
			"table": "m",
			"type": "ref",
			"possible_keys": "RID_RoundNo_PID_RegDate,PID",
			"key": "RID_RoundNo_PID_RegDate",
			"key_len": "155",
			"ref": "mpoker_datadb.p.rid,<subquery2>.RoundLogSeq,mpoker_datadb.p.PlayerId",
			"rows": 1,
			"Extra": null
		},
		{
			"id": 1,
			"select_type": "SIMPLE",
			"table": "ch",
			"type": "ref",
			"possible_keys": "idx_channelCode",
			"key": "idx_channelCode",
			"key_len": "4",
			"ref": "const",
			"rows": 5,
			"Extra": null
		},
		{
			"id": 1,
			"select_type": "SIMPLE",
			"table": "r2",
			"type": "ref",
			"possible_keys": "idx_channelCode",
			"key": "idx_channelCode",
			"key_len": "5",
			"ref": "mpoker_configdb.ch.channelCode",
			"rows": 122533,
			"Extra": "Using where"
		},
		{
			"id": 2,
			"select_type": "MATERIALIZED",
			"table": "p2",
			"type": "range",
			"possible_keys": "fk_roundlogseq,idx_upddate,idx_playerid",
			"key": "idx_upddate",
			"key_len": "6",
			"ref": null,
			"rows": 1,
			"Extra": "Using where"
		}
	]
}
```

```sql
explain select  p.Seq as logSeq, 
                p.rid as roomId, 
                p.RoundLogSeq as roundLogSeq, 
                p.PlayerId as playerId, 
                p.DeviceKey as deviceKey, 
                p.IpAddress as ipAddress, 
                p.RegDate as regDate, 
                p.seatNum, 
                p.bcardSuffle, 
                p.mainBetChip, 
                p.dealerCard, 
                p.userCard, 
                m.StartChip as startChip, 
                m.BettingChip as bettingChip, 
                m.ChangeChip as changeChip, 
                m.EndChip as endChip, 
                r.RoundNo as roundNo, 
                p.userHandCard, 
                p.splitCount, 
                p.mainBetResultChip, 
                p.dealerCardJokbo, 
                p.userCardResultReason, 
                p.userCardJokbo, 
                p.bAllin, 
                p.playerCount, 
                p.vecUserActionLog, 
                r.ShuffleNo as shuffleNo, 
                r.StartDate as roundStartDate, 
                r.EndDate as roundEndDate, 
                ch.ChannelName as channelCode, 
                r2.RoomNo as roomNo,  
                p.sideBetChip as sideBettingChip,  
                p.side21Plus3BetChip as sideBettingTpChip  
                from mpoker_datadb.TB_BlackJackPlayerLog as p  
                join mpoker_datadb.TB_BlackJackRoundLog as r on r.Seq = p.RoundLogSeq  
                join mpoker_datadb.TB_BlackJackPlayerMoneyLog as m on m.RoundLogSeq = p.RoundLogSeq and m.PlayerId = p.PlayerId and m.rid = p.rid   
                join mpoker_datadb.TB_BlackJackRoomLog as r2 on r2.Rid = p.rid  
                join mpoker_configdb.TB_ChannelConfig_Baccarat as ch on ch.ChannelCode = r2.ChannelCode and ch.gameCode = 2002  
                join (select p2.RoundLogSeq from mpoker_datadb.TB_BlackJackPlayerLog as p2 
					 where p2.RegDate >= '2019-11-01' and p2.RegDate <= '2019-11-02' and p2.PlayerId = 'B36DEBE63689485E9AAC08A4983FD9DA') as tt 
					 on tt.RoundLogSeq = p.RoundLogSeq
```
이래도 서브쿼리에서 ALL 탐

```
{
	"table": "알 수 없는 테이블",
	"rows":
	[
		{
			"id": 1,
			"select_type": "PRIMARY",
			"table": "<derived2>",
			"type": "ALL",
			"possible_keys": null,
			"key": null,
			"key_len": null,
			"ref": null,
			"rows": 2,
			"Extra": null
		},
		{
			"id": 1,
			"select_type": "PRIMARY",
			"table": "r",
			"type": "eq_ref",
			"possible_keys": "PRIMARY",
			"key": "PRIMARY",
			"key_len": "8",
			"ref": "tt.RoundLogSeq",
			"rows": 1,
			"Extra": null
		},
		{
			"id": 1,
			"select_type": "PRIMARY",
			"table": "p",
			"type": "ref",
			"possible_keys": "fk_roundlogseq,idx_playerid,idx_rid",
			"key": "fk_roundlogseq",
			"key_len": "8",
			"ref": "tt.RoundLogSeq",
			"rows": 1,
			"Extra": "Using where"
		},
		{
			"id": 1,
			"select_type": "PRIMARY",
			"table": "m",
			"type": "ref",
			"possible_keys": "RID_RoundNo_PID_RegDate,PID",
			"key": "RID_RoundNo_PID_RegDate",
			"key_len": "155",
			"ref": "mpoker_datadb.p.rid,tt.RoundLogSeq,mpoker_datadb.p.PlayerId",
			"rows": 1,
			"Extra": null
		},
		{
			"id": 1,
			"select_type": "PRIMARY",
			"table": "ch",
			"type": "ALL",
			"possible_keys": "idx_channelCode",
			"key": null,
			"key_len": null,
			"ref": null,
			"rows": 10,
			"Extra": "Using where; Using join buffer (Block Nested Loop)"
		},
		{
			"id": 1,
			"select_type": "PRIMARY",
			"table": "r2",
			"type": "ref",
			"possible_keys": "idx_channelCode",
			"key": "idx_channelCode",
			"key_len": "5",
			"ref": "mpoker_configdb.ch.channelCode",
			"rows": 122533,
			"Extra": "Using where"
		},
		{
			"id": 2,
			"select_type": "DERIVED",
			"table": "p2",
			"type": "range",
			"possible_keys": "idx_upddate,idx_playerid",
			"key": "idx_upddate",
			"key_len": "6",
			"ref": null,
			"rows": 1,
			"Extra": "Using where"
		}
	]
}
```


바꾼 결과 git patch

```
Index: src/main/java/com/fourones/persistence/mpoker/repository/gamedb/blackJack/BlackJackPlayGameLogRepository.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- src/main/java/com/fourones/persistence/mpoker/repository/gamedb/blackJack/BlackJackPlayGameLogRepository.java	(revision f4fc8dc41659f618fe85b6556cf736355212cf57)
+++ src/main/java/com/fourones/persistence/mpoker/repository/gamedb/blackJack/BlackJackPlayGameLogRepository.java	(revision 7c92ec9fa93002e8af706abee19cadd9a0eb79cd)
@@ -28,7 +28,7 @@
                 "from mpoker_datadb.TB_BlackJackPlayerLog as p " +
                 "join mpoker_datadb.TB_BlackJackRoundLog as r on r.Seq = p.RoundLogSeq " +
                 "join mpoker_datadb.TB_BlackJackPlayerMoneyLog as m on m.RoundLogSeq = p.RoundLogSeq and m.PlayerId = p.PlayerId and m.rid = p.rid  " +
-                "where p.RoundLogSeq in (select p2.RoundLogSeq from mpoker_datadb.TB_BlackJackPlayerLog as p2 where p2.RegDate >= ?1 and p2.RegDate <= ?2 and p2.PlayerId = ?3)";
+                "where p.RegDate >= ?1 and p.RegDate <= ?2 and p.PlayerId = ?3";
 
         Query q = entityManager.createNativeQuery(query);
         q.setParameter(1, begin, TemporalType.DATE);
@@ -81,7 +81,7 @@
                 "join mpoker_datadb.TB_BlackJackPlayerMoneyLog as m on m.RoundLogSeq = p.RoundLogSeq and m.PlayerId = p.PlayerId and m.rid = p.rid  " +
                 "join mpoker_datadb.TB_BlackJackRoomLog as r2 on r2.Rid = p.rid " +
                 "join mpoker_configdb.TB_ChannelConfig_Baccarat as ch on ch.ChannelCode = r2.ChannelCode and ch.gameCode = 2002 " +
-                "where p.RoundLogSeq in (select p2.RoundLogSeq from mpoker_datadb.TB_BlackJackPlayerLog as p2 where p2.RegDate >= ?1 and p2.RegDate <= ?2 and p2.PlayerId = ?3)";
+                "where p.RegDate >= ?1 and p.RegDate <= ?2 and p.PlayerId = ?3";
 
         Query q = entityManager.createNativeQuery(query, "BlackJackPlayLog");
         q.setParameter(1, begin, TemporalType.TIMESTAMP);

```