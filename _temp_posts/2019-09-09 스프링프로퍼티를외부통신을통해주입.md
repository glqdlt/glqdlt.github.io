---
layout: post
title:  "스프링프로퍼티를외부통신을통해주입"
author: "glqdlt"
---


자바는 기본적으로 psvm main 메소드를 통해 어플리케이션을 실행하게 된다. 메소드 프레임을 보면 최초의 스레드가 실행되고 이 스레드에 main 메소드를 통해 어플리케이션이 구동된다.

사실 프로그램이란게 기본적으로 os 를 통해 프로세스를 할당받게 된다.

프로세스는 당연히 JVM(자바 버추얼 머신) 런타임이 할당받게 되는 거고..

자바는 멀티스레드를 지원함으로, 기본적으로 프로세스 안에서 무조건  하나의 스레드를 만들어서 실행하게 된다.

이 스레드는 하드코딩된 main 메소드를 찾아서 어플리케이션을 부트스트랩하게 되는 데, 이 때문에 이 스레드를 Main 스레드라고 부르기도 한다.

1프로세스  - Main 스레드 

뭐 이런 구조가 되겠지..

얘기를 이제 조금 현실로 돌아와서 was 를 보자.

WAS 라는 것은 웹 어플리케이션 서버를 의미하고, 동적인 페이지를 렌더링 하는 것을 WAS 라고 한다.

비단 많은 코더들이 WAS 하면 자바 톰캣을 떠올리는 데, static 한 웹 서버가 아닌 이상 파이썬으로 하던 node js 기반으로 하던 html 컨텐츠가 동적으로 값이 바뀌고하는 서버면 다 WAS 이다. 

이야기를 돌아가서

JAVA EE는 엔터프라이즈 에디션 즉 비지니스 관련 된 스펙을 정의했다. 비지니스 하면 웹 서비스를 포함해서 여러 트랜잭션 처리라던지 설명하면 기니깐 비지니스 하면 떠오르는 기능들의 인터페이스를 정의해둔거다.

JAVA EE 에는 EJB 컨테이너, JMS, CDI, JTA, 서블릿 컨테이너 등이 있다.

톰캣과 같은 것들은 그러면 뭐냐인데, 톰캣은 경량 컨테이너 또는 경량 서블릿 컨테이너라 부른다. 즉 JAVA EE 의 일부인 서블릿 컨테이너를 의미한다.

어떠한 컨테이니깐 위의 자바 main 메소드 처럼 어떠한 진입점이 필요하다. 서블릿 3.0 스펙 하위 과거 버전은 web.xml 에 이를 정의했고, 3.0 이상 버전은 ??? 인터페이스를 구현하면 된다. 사실 ServeletContext.addDispatcherServlet() 을 통해 등록하는 거지만

스프링에서는 WebApplicationInitializer 자바를 구현해서 처리할수도있게 되어있다.



 JAVA EE 라는 자바 엔터프라이즈 에디션 스펙

WAS 는 기본적으로 ServletContainerInitializer 를 구현하고, 컨테이너에 등록할 서블릿들을 ServletInitializer 를 통해서 서블릿을 초기화하고 우리의 서블릿을 컨테이너에 등록하면서 우리가 일반적으로 기대하는 WAS 의 구실을 하게 된다.



어찌됬든

스프링은

1. 서블릿 컨테이너 또는 어플리케이션이 main 시작 됨

2. 어플리케이션 빌더를 만듬 (ConfigurableApplicationContext)

3. 하드코딩 된 환경변수들을 메모리에 로드함 (systemProperties, ArgsProperties, JNIProperties.. ㄷㅇ드으 ))

3. 스프링 어플리케이션 내부에서 관리되는 MutableProperties 

3. 스프링 프로퍼티 소스 어노테이션이나, 관련 어플리케이션 파일들을 읽어들임

4. 빈 팩토리 생성

5. 빈 검색

6. 빈 등록

이다.

그런데 내가 하고 싶은것은 레거시 프로젝트에서 envrioment 를 참조해서 datasource 를 만들고 있다. enviroment 에 property 를 꽂아주기만 하면 되는 데 문제는  3의 과정에 대해서 내가 개입을 할수가 없다.

여러가지 방안을 고민해봤는 데, ApplicationContext 의 event 를 기반으로 처리하려 했는 데, EventListener 를 등록하더라도 5의 시점 이후에 처리가 되어서, 내가 원하는 3의 과정에서 주입이 불가능하다.

또는 ApplicationContext 를 받아와서 하는 과정도 있는 데, 이 역시 ㅏㅁ찬가지이다.

특히 @Value 를 통해 spEL로 읽어들이는 부분은 읽는 시점도 참 모르겠다.

뭐 억지로 한다면 @DependOn 이나 Conditional 또는 ORder 를 통해서 조정을 할수도 있겠지만.. 뭔가 좀 깔끔하지가 않다.

그렇다고 1~3 과정에서 내가 훅으 걸만한 인터페이스는 보이지 않는다. 아무래도 static한 환경변수일 것이라고 가정하니 그런 것 같다.

결국은 아래와 방법 중에서 골라야 한다.

1. 자바 자체가 실행되기 전에 쉘 스크립트를 통해 프로퍼티를 읽어오는 어플리케이션을 실행시킨 후에 결과값을 자바 런타임 인자로 넘긴다.

2. 스프링 빌더를 만들기 전 시점에 환경변수를 셋팅해준다. 아마 이러면 서블릿 컨테이너가 생성될 쯤에 처리일것이다.

1의 경우는 개발 환경 구추하기가  어렵고, 2의 방안으로 처리를 해야한다. 그래서 서블릿 이니셜라이저와 같은 개념에 대해서 위에서 서술한 거고.
