---
layout: post
title:  "ㅁㅁㅁㅁ"
author: "glqdlt"
---


http://abc.abc.com/api/${game}/aaaa...

으로 오는 경우 game 에 해당하는 path variable 을 가져와서

유저 권한이 이를 이용할 수 있는지 인가 처리를 하고 싶었다.

스프링 시큐리티에서는

authentication(인증) 과 authorty(인가) 2개가 있다.

인증쪽은 일반적으로 user details 를 추상 클래스를 상속 한다던지, authrication manager 를 만들어서 연결시켜준다던지 하면 된다.

인가쪽은 관련해서 문서가 잘 없던데, 스프링 시큐리티 공식 문서에는 잘 설명되어있다.

https://docs.spring.io/spring-security/site/docs/current/reference/html/authorization.html

https://docs.spring.io/spring-security/site/docs/4.2.x/reference/html/authz-arch.html


인가는 accessdecisionmanager 에서 처리가 된다.

이놈은  authentication manager 와 provider 처럼

accessde manager와 voter 라는 개념의 관계가 있다.

voter 는 실제 인가 를 통과시켜줄지에 대한 로직이 작성되는 곳이다.

https://www.baeldung.com/spring-security-custom-voter
https://www.baeldung.com/spring-security-multiple-auth-providers
https://www.baeldung.com/spring-security-granted-authority-vs-role






https://www.baeldung.com/spring-security-custom-voter


AccessDecisionManager 를 직접 만들어서 security 에 연결시켜주는 식으로 처리를 했다.

UnanimousBased 에 넣어서 voter는 만들어서 잘 처리했다. 문제는

path variable 을 가져오는 아래 로직에서 문제가 있다.

```java
       @Override
        public int vote(Authentication authentication, FilterInvocation filter, Collection collection) {
            HttpServletRequest origin = filter.getHttpRequest();
            HttpServletRequest contextRequest = ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();
            Object pathVariable1 = origin.getAttribute(HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE);
            Map<String, String> pathVariable2 = (Map) contextRequest.getAttribute(HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE);
            // 아래 1은 그냥 테스트를 위해 GRANTED 처리
            return 1;
        }

```

둘다 null 이다.

이거에 대한 이유는 명확한데,  voter 가 실행되는 건 스프링시큐리티의 서블릿 필터에서 동작이 된다. 이게 내가 알기로는 최 앞단에 필터체인에 꽂히는 걸로 알고 있다. path variable 을 꽂아주는 인터셉터가 있을 텐데, 이 놈은 그 후에 실행이 된다. 

이 이유를 아는 건, pathvariable 을 또 다른 곳에서 attribute 를 셋업해주는 데, RequestMappingInfoHandlerMapping 여기서 처리되는 데 이놈이 터지는 시점이 다르기 때문이다.

필터가 다 통과한 이후에 실행되는 헬퍼 클래스이다. RequestMappingInfoHandlerMapping 은 인터셉터로 넘어가기 직전에 처리된다.
