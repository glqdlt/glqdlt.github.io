보통 e커머스 회사에 재직중인 분들의 배치작업 관련해서 많은 포스트가 보인다. 게임 회사도 마찬가지로 배치작업이 많이 필요하다.

사실 매출 집계와 같은 사업 수치 개념으로 보면 데이터 담당 조직에서 대부분 하지만, 나 같은 웹서비스 개발자들도 배치작업이 필요할 때가 많다. (사실 회사란 게 조직끼리 가위 바위 보 싸움으로 갈리긴한다 -_-)

나의 경우는 아래와 같다.

- 어뷰저(비행위 사용자) 제한 또는 제재

- 컨텐츠 일괄 회수 또는 지급

위의 경우는 데이터 유관 조직에서 담당하기 어려운 게임 서비스 영역이다. 보통 데이터 유관 조직에서 집계나 DB 로그 DUMP 같은 작업을 주로 한다, 즉 READ ONLY 작업이고

WITH WRITE 와 같은 트랜잭션 처리가 필요한 부분은 우리 조직에서 하고 있다.

처음에는 단순히 직접 구현해서 만들었다.

원리는 간단하다. 별도의 JobWorker 들을 관리하는 WorkerManager 라는 Worker 를 관리하는 스레드 풀 역활을 하는 컴포넌트를 만들고, 

while 무한루프 돌려서 1초마다 특정 DB를 폴링하면서 count 가 0 이상일 때 일을 해야한다고 판단하고(트리거) DB에서 일할거리를 가져와서 Worker 를 만들어서 스레드 풀에 던져놓고 땡이다.

이 때 일할거리는 100개의 offset 을줘서 100건 씩만 처리를 했었다. 서비스 초기에는 큰 무리 없이 잘 처리가 되었다. 몇 년 쯤 지나니 서비스가 고착화되고 커지면서 

100건씩 처리는 힘들어지는 상황이 오더라. 그래서 점차 스케일업을 할지 스케일아웃을 할지 고민이 생기고, FAIL OVER 에 대한 니즈도 점차 생겨났다.

이런 프로세스의 환경적인 부분에 대한 딥다이브 하기에는 회사에서 나에게 시간을 주지 않았고, 옆에서 곡소리 내는 운영 부서 잔소리를 들으면서

프레임워크를 사용하기로 했다. 뭐 다들 알다 싶이 스프링 프레임워크에 배치 프로젝트가 있어서 그걸 쓰기로 했다.

일괄작업에서 크게 2분류로 파츠를 나누어서 얘기를 할수 있다. 스케줄링과 작업 수행이다.

스케줄링은 위에서 잠시 얘기했던 것처럼 작업을 언제할지에 대한 스케줄을 의미한다. 언제라는 개념으로 보면 예약일 수도 있고, 지금부터 무제한으로 while 돌수도 있고 다양하다.

예약이란 개념으로 보면 언젠가는 수행되겠지만, 마음이 변해서 취소도 시킬수 있어야 한다. 이런 부분을 다 설계하고 구현하려면 생각보다 까다롭다.

여기서 사용해볼법한 프레임워크로 2가지를 고민했었다. 스프링 스케줄러와 쿼츠이다.

스프링 스케줄러는 매우 쉽고 단순하게 스케줄링을 돌수있게 해준다. cron 표기법도 지원해서 어노테이션만 달면 알아서 별도의 스레드에서 스케줄링 어노테이션이 달린 메소드를 실행해준다.

쿼츠는 고급 스케줄링까지 가능하다. 원격 트리거라던지 예약취소 등 별에 별 스케줄링 관련 기능이 집합된 거대한 프레임워크이다. 처음에는 라이브러리로 생각했는 데, 쿼츠는 단순히 스케줄링만 말고도 작업 수행도 할수있다. 다만 작업 수행은 아래에서 설명할 스프링 배치보다 기능이 다소 빈약하다. 

스프링 배치는 작업 수행을 담당하는 모듈이며, 배치 관련된 스프링 프레임워크의 프로젝트이다. 스프링 배치에서 가장 매력있는 것은 FAIL OVER 가 매우 쉽게 할 수 있다는 것이다.

FAIL OVER를 작업에 대한 수행단위로만 생각해서, 2개의 클러스터링을 통한 백업이 필요한가를 고민했었다.. 예를 들면 패치를 하기위해서 인스턴스를 셧다운 해야하는 경우도 있으니깐,

그래서 찾아보니 remote chucking 이라는 개념과 파티셔닝 2개가 있었다. https://docs.spring.io/spring-batch/docs/current/reference/html/scalability.html

이는 내가 원한 개념이 아니었는 데, 곰곰히 생각해보니 배치는 어떻게든 수행해야한다는 관점이 있어서 인스턴스가 셧다운되고 재부팅되어도 실패한 지점부터 작업을 수행할 수 있다는 점이었다.

또한 스프링 배치는 작업 단위에 READ -> Processing -> Write 개념의 파이프라인을 가지는 데, 여기서 READ 에 해당하는 ItemReader 인터페이스 하위 구현체중에 KafkaReader 도 있더라

Kafka 를 통해서 병렬 구성도 가능해보이겠다는 생각이 들었다.

[Spring Batch](https://spring.io/projects/spring-batch)

[Quartz](http://www.quartz-scheduler.org/)


