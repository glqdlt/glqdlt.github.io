
쿠폰에 대한 이야기는 이전에 s lock 과 w lock 에 대한 얘기를 했던 적이 있다. (글이 어디에 있는지 기억은 안남 아무튼 정리했었음)

lock 을 걸지 않고 하는 경우는 언젠간될것이다 라는 낙관적인 lock 으로 접근을 하게 된다. 

쿠폰 웹뷰는 사용자가 쿠폰을 사용하기 버튼을 클릭한후 http request 가 발생되면서 쿠폰 발급 트랜잭션(Db트랜잭션 얘기 아님, 서비스 프로세스에서의 이야기)이 시작된다. 트랜잭션은 유지되다 http response 가 응답될 때 끝나게 된다. 최종적으로 http response 의 메세지를 프론트엔드에서 해석하여 결과를 인지하고, 유저의 쿠폰이 사용되었는지 여부를 알려준다.

비동기식으로 택배 발송의 택배접수처럼 쿠폰 사용 접수라는 식으로 접근을 할까도 생각했다.

이 경우 쿠폰 사용 결과에 대한 알람을 전달해야하는 문제가 생긴다. 

메세지 알림을 받기 전에 웹뷰를 끄면 알람을 받지 못하지 않나 생각도 들었는데, 기존의 쿠폰 사용요청과 응답까지 한 사이클을 동기식으로 묶는 방법도 결과 메세지를 받기 전에 꺼버리면 같은 맥락이다. 백엔드 서버에서 쿠폰을 사용과정은 이미 진행이 되고 있기 때문.

결론은 lock 을 거는 전략 보다 낙관적인 lock 으로 접근해서 웹소켓을 통한 메세지 구독 방식(서버에서 메세지 푸시)이나 또는 SSE 프로토콜을 통해 쿠폰 처리 결과를 응답받는 것도 방법이겠다 싶었다. Azure service bus 나 event hub 같은 것을 사용해볼까도 싶었는데, 이친구들은 내부 internal infra에서만 사용할수 있다. 공개적인 네트워크에 모바일클라이언트는 리스닝할수 없다.

알람을 받는 모바일 클라이언트는 네트워크가 간혈적으로 끊어질수있다. 이 방법은 롱 폴링 모델이 나을 수 있다는 얘기가 된다. 무슨 얘기냐면 메세지 푸시의 경우 서버에서는 메세지를 보내고나면 끝인데, 이 순간 클라이언트 네트워크가 단절되어서 메세지를 수신했는지 서버에서는 알수없다. 나는 메세지 보냈는데? 배째 하고 말아버리는 상황. 클라이언트는 결국 서버에게 야 나 네트워크 끊긴 동안 메세지 보낸적있어? 라고 물어보게 된다. 문제는 서버가 대답을 안해주면 계속 메세지 보낸적있어? 메세지 보낸적있어? ... 라며 미친듯이 보내게 될 터이다. 네트워크가 간헐적으로 끊어지는 경우에 대해서는 웹소켓이나 SSE의 경우 이러한 미친듯이 알람 보낸적있냐고 물어보게 되거나.. 이를 제어 하기 위해 코드가 복잡해질수있다.
폴링 모델로 하면 코드도 간결해진다. 쿠폰 사용 요청 request 를 보낸 후, 폴링을 시작하는 로직을 수행한다. 메세지를 알람 받아 결과를 확인하거나 웹뷰가 꺼지면 폴링은 꺼진다.  레빗MQ는 폴링 모델을 사용하던 것으로 기억되는 데, 이러한 제약 때문이지 않나 상상을 해본다. 

메카니즘은 이러하고, 아키텍처를 구성해보자.

유저가 쿠폰 사용 버튼을 누르면 버튼이 dim 처리 되고, 서버에 쿠폰 사용 접수를 보내게된다. 서버는 이 접수를 받아 큐에 등록하고, 알람을 받을수있는 CouponJobState 라는 식별값을 준다. 이름에서 유추가능하지만 CouponJobState 은 쿠폰의 상태를 확인할수있는 식별값이다. 쿠폰 사용여부를 폴링할떄 이 CouponJobState 값으로 나의 쿠폰 상태를 확인할수 있다.

이제부터 핵심인데, 일반적으로 프론트엔드에서 쿠폰접수가 되었습니다. 라는 notification 과 함께 쿠폰 사용하기 버튼을 Enable 상태로 하게될텐데, 나는 이렇게 하지 않을 것이다. 쿠폰 사용 버튼은 여전히 dim 처리되어 먹통이 된 마냥 회색으로 되어있을것이다. 다만 자바스크립트 코드는 CouponJobState 값을 묻혀서 메세지 알람 API EndPoint 에 1초마다 질의할 것이다, 내 쿠폰 잘 처리되었어? 라고 물어본다. 결과는 진행중, 성공, 실패 이 3가지의 상태가 1초마다 응답될 것이다. 폴링하다가 성공이나 실패로 응답이 되면, 그때서야 메세지를 noti 하고 쿠폰 사용하기 버튼은 enable 된다. 이러면 사용자는 전통적인 동기적인 한 트랜잭션의 쿠폰사용 메카니즘으로 인지할뿐, 비동기 처리 되는걸 인지 할수 없다. 

